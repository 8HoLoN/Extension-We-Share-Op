{"version":3,"sources":["class/weshareop.js"],"names":["_g","WeShareOp","this","appName","alarmName","updateDelayInSecond","Object","defineProperty","value","writable","enumerable","configurable","userData","ws2016","numberOfSharesPurchased","numberOfSharesAcquired","amountOfInvestment","amundiAccount","login","pwd","_window","googleHackFinanceProvider","financeData","shareName","date","changePoint","changePercent","amundiTabId","amundiHomeUrl","amundiLoggingUrl","prototype","init","_this","that","updateFinanceData","chrome","alarms","clearAll","_wasCleared","onAlarm","addListener","_alarm","name","create","periodInMinutes","tabs","onRemoved","_tabId","_removeInfo","storage","local","set","wsoVersion","console","log","runtime","lastError","get","_items","sjcl","decrypt","id","wsoUserData","JSON","parse","e","displayI18n","_gEBI","document","getElementById","bind","_gM","i18n","getMessage","innerHTML","placeholder","href","displayData","toFixed","BUYING_PRICE","saveData","encrypt","stringify","ks","browserAction","addEventListener","options","selectedIndex","displayBagdeText","loginOnAmundiTab","executeScript","runAt","code","redirect","toString","_res","openNewAmundiTab","_this2","url","_tab","tab","windows","update","windowId","focused","highlighted","getFinanceData","_ok","xhr","XMLHttpRequest","open","onreadystatechange","readyState","status","_json","responseText","match","_priceUpdates","send","getPriceUpdates","_callback","_financeData","PriceUpdates","_this3","Date","_gain","_sign","setBadgeBackgroundColor","color","Math","abs","_badgeText","max","split","length","setBadgeText","text","setTitle","title","window"],"mappings":"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","file":"weshareop.js","sourcesContent":[";(function(_g){\r\n\t\"use strict\";\r\n\t\r\n\tfunction WeShareOp(){\r\n\t\tthis.appName = 'We Share Op.';\r\n\t\tthis.alarmName = 'WeShareOp';\r\n\t\tthis.updateDelayInSecond = 61;/* 10 600 */\r\n\r\n\t\tObject.defineProperty( this, 'BUYING_PRICE', {\r\n\t\t\tvalue: 101.62,\r\n\t\t\twritable: false,\r\n\t\t\tenumerable: true,\r\n\t\t\tconfigurable: true\r\n\t\t});\r\n\r\n\t\tthis.userData = {\r\n\t\t\tws2016 : {\r\n\t\t\t\tnumberOfSharesPurchased : 1,\r\n\t\t\t\tnumberOfSharesAcquired : 1*2,\r\n\t\t\t\tamountOfInvestment : 1*101.62*1.08,\r\n\t\t\t},\r\n\t\t\tamundiAccount : {\r\n\t\t\t\tlogin : '',\r\n\t\t\t\tpwd : '',\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tthis._window = null;\r\n\r\n\t\tthis.googleHackFinanceProvider = 'https://www.google.fr/async/finance_price_updates?dfsl=1&async=lang:fr,country:fr,rmids:%2Fg%2F1hbvm6lxm,_fmt:jspb&ei=rM4LV9XhAcG6arSluYgO&yv=2';\r\n\t\t\r\n\t\tthis.financeData = {\r\n\t\t\tshareName:'',\r\n\t\t\tdate:'',\r\n\t\t\tvalue:'',\r\n\t\t\tchangePoint:'',\r\n\t\t\tchangePercent:'',\r\n\t\t};\r\n\r\n\t\t// amundi\r\n\t\tthis.amundiTabId = null;\r\n\t\tthis.amundiHomeUrl = 'https://www.amundi-ee.com/part/home_login';\r\n\t\tthis.amundiLoggingUrl = 'https://www.amundi-ee.com/part/home_priv_synth';\r\n\t\t\r\n\t\t//this.init();\r\n\t};\r\n\r\n\tWeShareOp.prototype.init = function(){\r\n\t\tvar that = this;\r\n\t\tthis.updateFinanceData();\r\n\t\tchrome.alarms.clearAll((_wasCleared)=>{\r\n\t\t\tchrome.alarms.onAlarm.addListener((_alarm)=>{\r\n\t\t\t\tif(_alarm.name===this.alarmName){\r\n\t\t\t\t\tthis.updateFinanceData();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tchrome.alarms.create(this.alarmName, {periodInMinutes:this.updateDelayInSecond/60});\r\n\t\t});\r\n\t\tchrome.tabs.onRemoved.addListener((_tabId, _removeInfo)=>{\r\n\t\t\tif(this.amundiTabId===_tabId){\r\n\t\t\t\tthis.amundiTabId=null;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tchrome.storage.local.set({wsoVersion:'0.0.3'}, function (){\r\n\t\t\tconsole.log(chrome.runtime.lastError);\r\n\t\t\t//chrome.runtime.id\r\n\r\n\t\t\tchrome.storage.local.get(['wsoUserData','wsoVersion'], function (_items){\r\n\t\t\t\ttry{\r\n\t\t\t\t\tconsole.log(_items);\r\n\t\t\t\t\tconsole.log(sjcl.decrypt(\"wso\"+chrome.runtime.id,_items.wsoUserData));\r\n\t\t\t\t\tthat.userData = JSON.parse(sjcl.decrypt(\"wso\"+chrome.runtime.id,_items.wsoUserData));\r\n\t\t\t\t\tthat.updateFinanceData();\r\n\t\t\t\t}catch (e){\r\n\t\t\t\t\tconsole.log(e);\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t};\r\n\r\n\tWeShareOp.prototype.displayI18n = function(_window){\r\n\t\t//var _currentLocale = chrome.i18n.getMessage(\"@@ui_locale\");\r\n\t\t//console.log(_currentLocale);\r\n\t\tvar _gEBI = _window.document.getElementById.bind(_window.document);\r\n\t\tvar _gM = chrome.i18n.getMessage;\r\n\r\n\t\t_gEBI(\"wso-statsTabLabel\").innerHTML = _gM(\"statsTabName\");\r\n\t\t_gEBI(\"wso-sharesValueLabel\").innerHTML = _gM(\"sharesValueLabel\");\r\n\t\t_gEBI(\"wso-investmentValueLabel\").innerHTML = _gM(\"investmentValueLabel\");\r\n\t\t_gEBI(\"wso-capitalGainLabel\").innerHTML = _gM(\"capitalGainLabel\");\r\n\t\t_gEBI(\"wso-overallGainLabel\").innerHTML = _gM(\"overallGainLabel\");\r\n\r\n\t\t_gEBI(\"wso-sharesTabLabel\").innerHTML = _gM(\"sharesTabLabel\");\r\n\t\t_gEBI(\"wso-numberOfSharesPurchasedLabel\").innerHTML = _gM(\"numberOfSharesPurchasedLabel\");\r\n\t\t_gEBI(\"wso-numberOfSharesAcquiredLabel\").innerHTML = _gM(\"numberOfSharesAcquiredLabel\");\r\n\t\t_gEBI(\"wso-buyingPriceLabel\").innerHTML = _gM(\"buyingPriceLabel\");\r\n\t\t_gEBI(\"wso-amountOfInvestmentLabel\").innerHTML = _gM(\"amountOfInvestmentLabel\");\r\n\r\n\t\t_gEBI(\"wso-amundiAccountTabLabel\").innerHTML = _gM(\"amundiAccountTabLabel\");\r\n\t\t_gEBI(\"wso-amundiLoginLabel\").innerHTML = _gM(\"amundiLoginLabel\");\r\n\t\t_gEBI(\"wso-amundiLogin\").placeholder = _gM(\"amundiLoginPlaceholder\");\r\n\t\t_gEBI(\"wso-amundiPasswordLabel\").innerHTML = _gM(\"amundiPasswordLabel\");\r\n\t\t_gEBI(\"wso-amundiPassword\").placeholder = _gM(\"amundiPasswordPlaceholder\");\r\n\r\n\t\t_gEBI(\"wso-amundiAccess\").innerHTML = _gM(\"amundiAccess\");\r\n\t\t_gEBI(\"wso-infoTabLabel\").innerHTML = _gM(\"infoTabLabel\");\r\n\t\t_gEBI(\"wso-aboutTabLabel\").innerHTML = _gM(\"aboutTabLabel\");\r\n\r\n\t\t_gEBI(\"wso-feedback\").href = \"mailto:\"+\"8holon\"+\"@\"+\"gmail.com?Subject=Feedback\";\r\n\t\t_gEBI(\"wso-feedback\").innerHTML = \"8holon\"+\"&#64;\"+\"gmail.com\";\r\n\t};\r\n\r\n\tWeShareOp.prototype.displayData = function(_window){\r\n\t\tvar _gEBI = _window.document.getElementById.bind(_window.document);\r\n\t\t_gEBI('wso-sharesValue').value = this.financeData.value.toFixed(2)+'€';\r\n\t\t_gEBI('wso-investmentValue').value = (this.financeData.value*this.userData.ws2016.numberOfSharesAcquired).toFixed(2)+'€';\r\n\t\t_gEBI('wso-capitalGain').value = ((this.financeData.value - this.BUYING_PRICE)*this.userData.ws2016.numberOfSharesAcquired).toFixed(2)+'€';\r\n\t\t_gEBI('wso-overallGain').value = ((this.financeData.value*this.userData.ws2016.numberOfSharesAcquired)-this.userData.ws2016.amountOfInvestment).toFixed(2)+'€';\r\n\r\n\t\t_gEBI(\"wso-numberOfSharesPurchased\").value=this.userData.ws2016.numberOfSharesPurchased;\r\n\t\t_gEBI('wso-numberOfSharesAcquired').value=this.userData.ws2016.numberOfSharesAcquired;\r\n\t\t_gEBI('wso-amountOfInvestment').value=this.userData.ws2016.amountOfInvestment.toFixed(2)+'€';\r\n\t\t_gEBI('wso-amundiLogin').value=this.userData.amundiAccount.login;\r\n\t\t_gEBI('wso-amundiPassword').value=this.userData.amundiAccount.pwd;\r\n\t};\r\n\r\n\tWeShareOp.prototype.saveData = function(){\r\n\t\tchrome.storage.local.set({wsoUserData:sjcl.encrypt(\"wso\"+chrome.runtime.id,JSON.stringify(this.userData),{ks:256})}, function (){\r\n\t\t\tconsole.log('saveError',chrome.runtime.lastError);\r\n\t\t\t//chrome.runtime.id\r\n\t\t});\r\n\t};\r\n\r\n\tWeShareOp.prototype.browserAction = function(_window){\r\n\t\tvar that=this;\r\n\t\tconsole.log(\"browserAction\");\r\n\t\tthis._window = _window;\r\n\r\n\t\t_window.addEventListener(\"unload\", function(){\r\n\t\t\tthat._window = null;\r\n\t\t});\r\n\r\n\t\tthis.displayI18n(_window);\r\n\t\tthis.displayData(_window);\r\n\t\t//_window.close();\r\n\t\tvar _gEBI = _window.document.getElementById.bind(_window.document);\r\n\t\t_gEBI('wso-amundiLogin').addEventListener('keyup',function(){\r\n\t\t\tthat.userData.amundiAccount.login = this.value;\r\n\t\t\tthat.saveData();\r\n\t\t});\r\n\t\t_gEBI('wso-amundiPassword').addEventListener('keyup',function(){\r\n\t\t\tthat.userData.amundiAccount.pwd = this.value;\r\n\t\t\tthat.saveData();\r\n\t\t});\r\n\t\t_gEBI('wso-numberOfSharesPurchased').addEventListener('change',function(){\r\n\t\t\tthat.userData.ws2016.numberOfSharesPurchased = +this.options[this.selectedIndex].value;\r\n\t\t\tthat.userData.ws2016.numberOfSharesAcquired = that.userData.ws2016.numberOfSharesPurchased*2;\r\n\t\t\tthat.userData.ws2016.amountOfInvestment = that.userData.ws2016.numberOfSharesPurchased*that.BUYING_PRICE*1.08;\r\n\r\n\t\t\tthat.saveData();\r\n\t\t\tthat.displayData(_window);\r\n\t\t\tthat.displayBagdeText();\r\n\t\t});\r\n\t};\r\n\r\n\tWeShareOp.prototype.loginOnAmundiTab = function(){\r\n\t\tchrome.tabs.executeScript(this.amundiTabId, {\r\n\t\t\trunAt:'document_end',\r\n\t\t\tcode: ';(function(){'+\r\n\t\t\t\tredirect.toString()+\r\n\t\t\t\t\"redirect('\"+this.amundiLoggingUrl+\"',{\"+\r\n\t\t\t\t\t\"method:'POST',\"+\r\n\t\t\t\t\t\"target:'_self',\"+\r\n\t\t\t\t\t\"data:{\"+\r\n\t\t\t\t\t\"\tmail:\"+this.userData.amundiAccount.login+\",\"+\r\n\t\t\t\t\t\"\tpassword:\"+this.userData.amundiAccount.pwd+\",\"+\r\n\t\t\t\t\t\"\tconnection:''\"+\r\n\t\t\t\t\t\"}\"+\r\n\t\t\t\t\"});\"+\r\n\t\t\t\t\"return 0xff08;\"+\r\n\t\t\t\"})();\"}, function(_res){\r\n\t\t\t// _res[0]===0xff08\r\n\t\t\t// console.log('test',_res);\r\n\t\t});\r\n\t};\r\n\r\n\tWeShareOp.prototype.openNewAmundiTab = function(){\r\n\t\tvar that = this;\r\n\r\n\t\tif( this.amundiTabId === null ){\r\n\t\t\tchrome.tabs.create({ url: this.amundiHomeUrl },(_tab)=>{\r\n\t\t\t\tthis.amundiTabId = _tab.id;\r\n\t\t\t\tthis.loginOnAmundiTab();\r\n\t\t\t\tconsole.log(that.amundiTabId);\r\n\r\n\t\t\t});\r\n\t\t}else{// TODO check last error in chrome callback (ie close before execute script)\r\n\t\t\t/*\r\n\t\t\tchrome.tabs.get(this.amundiTabId, function(_tab){\r\n\t\t\tif (chrome.runtime.lastError) {\r\n\t\t\tconsole.log(chrome.runtime.lastError.message);\r\n\t\t\t} else {\r\n\t\t\t\t// Tab exists\r\n\t\t\t}\r\n\t\t\t\tconsole.log('tab_',_tab);\r\n\t\t\t});\r\n\t\t\t//*/\r\n\r\n\t\t\tchrome.tabs.get(this.amundiTabId, (tab)=>{\r\n\t\t\t\tchrome.windows.update(tab.windowId, {focused:true}, (_window)=>{\r\n\r\n\t\t\t\t});\r\n\t\t\t\tconsole.log(tab);\r\n\t\t\t\tchrome.tabs.update(that.amundiTabId, {url:this.amundiHomeUrl,highlighted:true}, (_tab)=>{\r\n\t\t\t\t\tthis.loginOnAmundiTab();\r\n\t\t\t\t});\r\n\r\n\t\t\t});\r\n\r\n\t\t}\r\n\r\n\r\n\t};\r\n\r\n\tWeShareOp.prototype.getFinanceData = function(_ok){\r\n\t\tvar that = this;\r\n\t\t\r\n\t\tvar xhr = new XMLHttpRequest();\r\n\t\txhr.open(\"GET\", this.googleHackFinanceProvider, true);\r\n\t\txhr.onreadystatechange = function() {\r\n\t\t\tif (xhr.readyState == 4  ) {\r\n\t\t\t\tif( xhr.status == 200 ){\r\n\t\t\t\t\tvar _json = xhr.responseText.match(/{\"PriceUpdates\":[\\s\\S]*}/);\r\n\t\t\t\t\tif( _json!==null ){\r\n\t\t\t\t\t\tconsole.log(_json[0]);\r\n\t\t\t\t\t\tvar _priceUpdates = JSON.parse(_json[0]);\r\n\t\t\t\t\t\t_ok(_priceUpdates);\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\tconsole.log(\"Google Finance Error\");\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tconsole.log(\"Google Error\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\txhr.send();\r\n\t};\r\n\r\n\tWeShareOp.prototype.getPriceUpdates = function(_callback){\r\n\t\tvar that = this;\r\n\t\tthis.getFinanceData(function(_financeData){\r\n\t\t\t//console.log(that);\r\n\t\t\tthat.financeData.shareName = _financeData.PriceUpdates[0][0][2];\r\n\t\t\tthat.financeData.date = _financeData.PriceUpdates[0][0][3];\r\n\t\t\t//that.financeData.value = _financeData.PriceUpdates[0][0][1][0];\r\n\t\t\tthat.financeData.value = _financeData.PriceUpdates[0][0][1][8][1];\r\n\t\t\tthat.financeData.changePoint = _financeData.PriceUpdates[0][0][1][1];\r\n\t\t\tthat.financeData.changePercent = _financeData.PriceUpdates[0][0][1][2];\r\n\t\t\t\r\n\t\t\t/*\r\n\t\t\tconsole.log(_financeData);\r\n\t\t\tconsole.log('valeur',_financeData.PriceUpdates[0][0][1][0]);// valeur\r\n\t\t\tconsole.log('variation',_financeData.PriceUpdates[0][0][1][1]);// différence (variation en point) depuis la dernière ouverture\r\n\t\t\tconsole.log('variation%',_financeData.PriceUpdates[0][0][1][2]);// derivée (variation en %) depuis la dernière ouverture\r\n\t\t\tconsole.log('sens',_financeData.PriceUpdates[0][0][1][3]);// 1 positive / 0 negative\r\n\t\t\tconsole.log('name',_financeData.PriceUpdates[0][0][2]);// action name\r\n\t\t\tconsole.log('date',_financeData.PriceUpdates[0][0][3]);// date\r\n\t\t\t\r\n\t\t\tconsole.log('accurateValue',_financeData.PriceUpdates[0][0][1][8][1]);// valeur\r\n\t\t\tconsole.log('accurateVariation',_financeData.PriceUpdates[0][0][1][9][1]);// différence (variation en point) depuis la dernière ouverture\r\n\t\t\tconsole.log('accurateVariation%',_financeData.PriceUpdates[0][0][1][10][1]);// derivée (variation en %) depuis la dernière ouverture\r\n\t\t\t//*/\r\n\t\t\t_callback();\r\n\t\t});\r\n\t};\r\n\r\n\t// http://stackoverflow.com/questions/20279484/how-to-access-the-correct-this-context-inside-a-callback\r\n\tWeShareOp.prototype.updateFinanceData = function(_callback){\r\n\t\tthis.getPriceUpdates(()=>{\r\n\t\t\tconsole.log('priceUpdate',new Date());\r\n\r\n\t\t\tthis.displayBagdeText();\r\n\t\t\tif( this._window!==null ){\r\n\t\t\t\tthis.displayData(this._window);\r\n\t\t\t}\r\n\r\n\t\t\t\r\n\t\t});\r\n\t};\r\n\r\n\tWeShareOp.prototype.displayBagdeText = function(){\r\n\t\tvar _gain = (this.financeData.value - this.BUYING_PRICE)*this.userData.ws2016.numberOfSharesAcquired;\r\n\t\tvar _sign = '-';\r\n\t\tif( _gain > 0 ){\r\n\t\t\t_sign = '+';\r\n\t\t\tchrome.browserAction.setBadgeBackgroundColor({color:'#05bb05'});\r\n\t\t}else{\r\n\t\t\tchrome.browserAction.setBadgeBackgroundColor({color:'#881111'});\r\n\t\t}\r\n\t\t_gain = Math.abs(_gain);\r\n\t\t// ok for this.financeData.value [0;274]\r\n\t\t//var _badgeText = Math.abs(_gain).toFixed(0)+' €';\r\n\t\tvar _badgeText = Math.abs(_gain).toFixed( Math.max(3-_gain.toFixed(2).split('.')[0].length,0) );\r\n\t\tchrome.browserAction.setBadgeText({text:''+ _badgeText });\r\n\r\n\t\tchrome.browserAction.setTitle({title : this.appName+' ('+_sign+_gain.toFixed(2)+'€)' });\r\n\t};\r\n\r\n\t_g.WeShareOp = new WeShareOp();\r\n\r\n})(this||window);\r\n\r\n"]}