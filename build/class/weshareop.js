"use strict";!function(e){function a(){this.appName="We Share Op.",this.alarmName="WeShareOp",this.updateDelayInSecond=61,Object.defineProperty(this,"BUYING_PRICE",{value:101.62,writable:!1,enumerable:!0,configurable:!0}),this.userData={ws2016:{numberOfSharesPurchased:1,numberOfSharesAcquired:2,amountOfInvestment:101.62*1.08},amundiAccount:{login:"",pwd:""}},this._window=null,this.googleHackFinanceProvider="https://www.google.fr/async/finance_price_updates?dfsl=1&async=lang:fr,country:fr,rmids:%2Fg%2F1hbvm6lxm,_fmt:jspb&ei=rM4LV9XhAcG6arSluYgO&yv=2",this.financeData={shareName:"",date:"",value:"",changePoint:"",changePercent:""},this.amundiTabId=null,this.amundiHomeUrl="https://www.amundi-ee.com/part/home_login",this.amundiLoggingUrl="https://www.amundi-ee.com/part/home_priv_synth"}a.prototype.init=function(){var e=this,a=this;this.updateFinanceData(),chrome.alarms.clearAll(function(a){chrome.alarms.onAlarm.addListener(function(a){a.name===e.alarmName&&e.updateFinanceData()}),chrome.alarms.create(e.alarmName,{periodInMinutes:e.updateDelayInSecond/60})}),chrome.tabs.onRemoved.addListener(function(a,n){e.amundiTabId===a&&(e.amundiTabId=null)}),chrome.storage.local.set({wsoVersion:"0.0.3"},function(){console.log(chrome.runtime.lastError),chrome.storage.local.get(["wsoUserData","wsoVersion"],function(e){try{console.log(e),console.log(sjcl.decrypt("wso"+chrome.runtime.id,e.wsoUserData)),a.userData=JSON.parse(sjcl.decrypt("wso"+chrome.runtime.id,e.wsoUserData)),a.updateFinanceData()}catch(n){console.log(n)}})})},a.prototype.displayI18n=function(e){var a=e.document.getElementById.bind(e.document),n=chrome.i18n.getMessage;a("wso-statsTabLabel").innerHTML=n("statsTabName"),a("wso-sharesValueLabel").innerHTML=n("sharesValueLabel"),a("wso-investmentValueLabel").innerHTML=n("investmentValueLabel"),a("wso-capitalGainLabel").innerHTML=n("capitalGainLabel"),a("wso-overallGainLabel").innerHTML=n("overallGainLabel"),a("wso-sharesTabLabel").innerHTML=n("sharesTabLabel"),a("wso-numberOfSharesPurchasedLabel").innerHTML=n("numberOfSharesPurchasedLabel"),a("wso-numberOfSharesAcquiredLabel").innerHTML=n("numberOfSharesAcquiredLabel"),a("wso-buyingPriceLabel").innerHTML=n("buyingPriceLabel"),a("wso-amountOfInvestmentLabel").innerHTML=n("amountOfInvestmentLabel"),a("wso-amundiAccountTabLabel").innerHTML=n("amundiAccountTabLabel"),a("wso-amundiLoginLabel").innerHTML=n("amundiLoginLabel"),a("wso-amundiLogin").placeholder=n("amundiLoginPlaceholder"),a("wso-amundiPasswordLabel").innerHTML=n("amundiPasswordLabel"),a("wso-amundiPassword").placeholder=n("amundiPasswordPlaceholder"),a("wso-amundiAccess").innerHTML=n("amundiAccess"),a("wso-infoTabLabel").innerHTML=n("infoTabLabel"),a("wso-aboutTabLabel").innerHTML=n("aboutTabLabel"),a("wso-feedback").href="mailto:8holon@gmail.com?Subject=Feedback",a("wso-feedback").innerHTML="8holon&#64;gmail.com"},a.prototype.displayData=function(e){var a=e.document.getElementById.bind(e.document);a("wso-sharesValue").value=this.financeData.value.toFixed(2)+"€",a("wso-investmentValue").value=(this.financeData.value*this.userData.ws2016.numberOfSharesAcquired).toFixed(2)+"€",a("wso-capitalGain").value=((this.financeData.value-this.BUYING_PRICE)*this.userData.ws2016.numberOfSharesAcquired).toFixed(2)+"€",a("wso-overallGain").value=(this.financeData.value*this.userData.ws2016.numberOfSharesAcquired-this.userData.ws2016.amountOfInvestment).toFixed(2)+"€",a("wso-numberOfSharesPurchased").value=this.userData.ws2016.numberOfSharesPurchased,a("wso-numberOfSharesAcquired").value=this.userData.ws2016.numberOfSharesAcquired,a("wso-amountOfInvestment").value=this.userData.ws2016.amountOfInvestment.toFixed(2)+"€",a("wso-amundiLogin").value=this.userData.amundiAccount.login,a("wso-amundiPassword").value=this.userData.amundiAccount.pwd},a.prototype.saveData=function(){chrome.storage.local.set({wsoUserData:sjcl.encrypt("wso"+chrome.runtime.id,JSON.stringify(this.userData),{ks:256})},function(){console.log("saveError",chrome.runtime.lastError)})},a.prototype.browserAction=function(e){var a=this;console.log("browserAction"),this._window=e,e.addEventListener("unload",function(){a._window=null}),this.displayI18n(e),this.displayData(e);var n=e.document.getElementById.bind(e.document);n("wso-amundiLogin").addEventListener("keyup",function(){a.userData.amundiAccount.login=this.value,a.saveData()}),n("wso-amundiPassword").addEventListener("keyup",function(){a.userData.amundiAccount.pwd=this.value,a.saveData()}),n("wso-numberOfSharesPurchased").addEventListener("change",function(){a.userData.ws2016.numberOfSharesPurchased=+this.options[this.selectedIndex].value,a.userData.ws2016.numberOfSharesAcquired=2*a.userData.ws2016.numberOfSharesPurchased,a.userData.ws2016.amountOfInvestment=a.userData.ws2016.numberOfSharesPurchased*a.BUYING_PRICE*1.08,a.saveData(),a.displayData(e),a.displayBagdeText()})},a.prototype.loginOnAmundiTab=function(){chrome.tabs.executeScript(this.amundiTabId,{runAt:"document_end",code:";(function(){"+redirect.toString()+"redirect('"+this.amundiLoggingUrl+"',{method:'POST',target:'_self',data:{	mail:"+this.userData.amundiAccount.login+",	password:"+this.userData.amundiAccount.pwd+",	connection:''}});return 0xff08;})();"},function(e){})},a.prototype.openNewAmundiTab=function(){var e=this,a=this;null===this.amundiTabId?chrome.tabs.create({url:this.amundiHomeUrl},function(n){e.amundiTabId=n.id,e.loginOnAmundiTab(),console.log(a.amundiTabId)}):chrome.tabs.get(this.amundiTabId,function(n){chrome.windows.update(n.windowId,{focused:!0},function(e){}),console.log(n),chrome.tabs.update(a.amundiTabId,{url:e.amundiHomeUrl,highlighted:!0},function(a){e.loginOnAmundiTab()})})},a.prototype.getFinanceData=function(e){var a=new XMLHttpRequest;a.open("GET",this.googleHackFinanceProvider,!0),a.onreadystatechange=function(){if(4==a.readyState)if(200==a.status){var n=a.responseText.match(/{"PriceUpdates":[\s\S]*}/);if(null!==n){console.log(n[0]);var t=JSON.parse(n[0]);e(t)}else console.log("Google Finance Error")}else console.log("Google Error")},a.send()},a.prototype.getPriceUpdates=function(e){var a=this;this.getFinanceData(function(n){a.financeData.shareName=n.PriceUpdates[0][0][2],a.financeData.date=n.PriceUpdates[0][0][3],a.financeData.value=n.PriceUpdates[0][0][1][8][1],a.financeData.changePoint=n.PriceUpdates[0][0][1][1],a.financeData.changePercent=n.PriceUpdates[0][0][1][2],e()})},a.prototype.updateFinanceData=function(e){var a=this;this.getPriceUpdates(function(){console.log("priceUpdate",new Date),a.displayBagdeText(),null!==a._window&&a.displayData(a._window)})},a.prototype.displayBagdeText=function(){var e=(this.financeData.value-this.BUYING_PRICE)*this.userData.ws2016.numberOfSharesAcquired,a="-";e>0?(a="+",chrome.browserAction.setBadgeBackgroundColor({color:"#05bb05"})):chrome.browserAction.setBadgeBackgroundColor({color:"#881111"}),e=Math.abs(e);var n=Math.abs(e).toFixed(Math.max(3-e.toFixed(2).split(".")[0].length,0));chrome.browserAction.setBadgeText({text:""+n}),chrome.browserAction.setTitle({title:this.appName+" ("+a+e.toFixed(2)+"€)"})},e.WeShareOp=new a}(window);
//# sourceMappingURL=weshareop.js.map
